<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>微服务 API 网关 Kong 2.0.0 升级指南 | 把酒诗代码，趁乱写年华。</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.1/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.1/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.1/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-115330315-2','auto');ga('send','pageview');
</script><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/2.0.4/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/2.1.4/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/2.1.4/toastr.min.css"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">微服务 API 网关 Kong 2.0.0 升级指南</h1><a id="logo" href="/.">把酒诗代码，趁乱写年华。</a><p class="description">是谁来自 Python Java, 却囿于 PHP, Go 与 Lua。（上述语言博主一概不会。）</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/tags/"><i class="fa fa-tag"> 标签</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">微服务 API 网关 Kong 2.0.0 升级指南</h1><div class="post-meta">2020-06-05<span> | </span><span class="category"><a href="/categories/与代码/">与代码</a></span></div><a class="disqus-comment-count" href="/2020/06/05/kong-2.0-upgrade-guide/#vcomment"><span class="valine-comment-count" data-xid="/2020/06/05/kong-2.0-upgrade-guide/"></span><span> 条评论</span></a><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#升级到-2-0-0"><span class="toc-number">1.</span> <span class="toc-text">升级到 2.0.0</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-依赖项"><span class="toc-number">1.1.</span> <span class="toc-text">1. 依赖项</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-重大修改项"><span class="toc-number">1.2.</span> <span class="toc-text">2. 重大修改项</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-建议升级路径"><span class="toc-number">1.3.</span> <span class="toc-text">3. 建议升级路径</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#从0-x升级到2-0-0"><span class="toc-number">1.3.1.</span> <span class="toc-text">从0.x升级到2.0.0</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#从1-0-0-1-5-0-升级到-2-0-0"><span class="toc-number">1.3.2.</span> <span class="toc-text">从1.0.0 - 1.5.0 升级到 2.0.0</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#在新的数据存储上安装2-0-0"><span class="toc-number">1.3.3.</span> <span class="toc-text">在新的数据存储上安装2.0.0</span></a></li></ol></li></ol></li></ol></div></div><div class="post-content"><p>原文地址：<a href="https://docs.konghq.com/2.0.x/upgrading/" target="_blank" rel="external">https://docs.konghq.com/2.0.x/upgrading/</a>  （不能保证所有的翻译都是准确无误的，所有如有翻译的不准确或错误之处，请一定记得查看原文，并欢迎留言指出）<br>注意: 下面是2.0.x的升级指南。如果您试图升级到早期版本的Kong，请阅读<a href="UPGRADE.md file in the Kong repo">upgrade.md</a>文件。<br>本指南将告诉您在升级时应该注意的重大更改，并指导您完成正确的步骤顺序，以便在不同的升级场景中实现无停机迁移。</p>
<h1 id="升级到-2-0-0"><a href="#升级到-2-0-0" class="headerlink" title="升级到 2.0.0"></a>升级到 2.0.0</h1><p>Kong坚持语义化版本，区分“主要”、“次要”和“补丁”版本。升级路径与您要迁移的前一个版本不同。升级到2.0。是一个主要的版本升级，所以要注意在<a href="https://github.com/Kong/kong/blob/2.0.0/CHANGELOG.md" target="_blank" rel="external">CHANGELOG.md</a>文档中列出的任何重大更改。</p>
<h2 id="1-依赖项"><a href="#1-依赖项" class="headerlink" title="1. 依赖项"></a>1. 依赖项</h2><p>如果您正在使用已提供的二进制包，那么所有必要的依赖项都已绑定，可以跳过此部分。</p>
<p>如果您是手动构建您的依赖项，那么自上一个版本以来有一些更改，因此您将需要使用最新的补丁重新构建它们。</p>
<p>所需的OpenResty版本是<a href="http://openresty.org/en/changelog-1015008.html" target="_blank" rel="external">1.15.8.2</a>，其中包含的OpenResty补丁集已经改变，包括最新版本的<a href="lua-kong-nginx-module">lua-kong-nginx-module</a>。我们的<a href="https://github.com/Kong/kong-build-tools" target="_blank" rel="external">kong-build-tools</a>库允许您轻松地使用必要的补丁和模块构建OpenResty。</p>
<p>对于GO的支持，你还需要<a href="https://github.com/kong/go-pluginserver" target="_blank" rel="external">Kong go-pluginserver</a>。这是与Kong二进制包绑定的，如果在Kong的配置中启用Go插件支持，它会自动启动。注意，用于编译任何Go插件的Go版本需要匹配<code>go-pluginserver</code>的Go版本。可以检查用于构建运行<code>go-pluginserver</code>版本的<code>gopluginserver</code>二进制文件的Go版本。</p>
<h2 id="2-重大修改项"><a href="#2-重大修改项" class="headerlink" title="2. 重大修改项"></a>2. 重大修改项</h2><p>Kong 2.0.0包含了对Kong 1.x的一些重大更改，且都和移除Service Mesh相关：</p>
<ul>
<li><strong>删除了Service Mesh支持</strong>：在Kong 1.4中已经被弃用了，并且默认设置了，现在代码已经在2.0中直接去掉。对于Service Mesh，我们现在有了Kuma，这是从一开始就为Mesh模式设计的，所以我们对移除Kong的本地Service Mesh功能感到放心，并专注于其作为网关的核心功能。</li>
<li>作为服务网格移除的一部分，无服务代理被移除。在创建用于无服务器插件(如<code>aws-lambda</code>或<code>request-termination</code>)的路由时，您仍然可以设置<code>service = null</code>。</li>
<li>移除 <code>origins</code> 属性。</li>
<li>移除 <code>transparent</code> 属性。</li>
<li>移除了用于服务网格的 Sidecar Injector plugin 插件。</li>
<li><strong>NGINX 配置文件改变</strong>：这意味着如果您使用自定义模板，则需要对其进行更新。改进了流模式支持，使Nginx注入系统更加强大，这样定制模板就不那么必要了。下面的差异中详细介绍了这些变化。<ul>
<li><strong>警告</strong>：注意<code>kong_cache</code> shm被分割成两个shm: <code>kong_core_cache</code>和k<code>ong_cache</code>。如果使用自定义Nginx模板，请确保定义了核心缓存共享字典，包括无数据库模式阴影定义。这两个缓存值都依赖于已经存在的<code>mem_cache_size</code>配置选项来设置它们的大小，因此当从以前的Kong版本升级时，如果不调整该值，缓存内存消耗可能会翻倍。</li>
</ul>
</li>
</ul>
<p>Nginx 配置改变如下：</p>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div></pre></td><td class="code"><pre><div class="line">diff --git a/kong/templates/nginx_kong.lua b/kong/templates/nginx_kong.lua</div><div class="line">index 5c6c1db03..6b4b4a818 100644</div><div class="line">-<span class="ruby">-- a/kong/templates/nginx_kong.lua</span></div><div class="line"><span class="ruby">+++ b/kong/templates/nginx_kong.lua</span></div><div class="line"><span class="ruby">@@ -<span class="number">5</span>,<span class="number">52</span> +<span class="number">5</span>,<span class="number">46</span> @@ server_tokens off;</span></div><div class="line"><span class="ruby"> &gt; <span class="keyword">if</span> anonymous_reports <span class="keyword">then</span></span></div><div class="line"><span class="ruby"> $</span></div><div class="line"><span class="ruby"> &gt; <span class="keyword">end</span></span></div><div class="line"><span class="ruby">-</span></div><div class="line"><span class="ruby"> error_log $ $;</span></div><div class="line"><span class="ruby"></span></div><div class="line"><span class="ruby">-&gt; <span class="keyword">if</span> nginx_optimizations <span class="keyword">then</span></span></div><div class="line"><span class="ruby">-&gt;-- send_timeout <span class="number">60</span>s;          <span class="comment"># default value</span></span></div><div class="line"><span class="ruby">-&gt;-- keepalive_timeout <span class="number">75</span>s;     <span class="comment"># default value</span></span></div><div class="line"><span class="ruby">-&gt;-- client_body_timeout <span class="number">60</span>s;   <span class="comment"># default value</span></span></div><div class="line"><span class="ruby">-&gt;-- client_header_timeout <span class="number">60</span>s; <span class="comment"># default value</span></span></div><div class="line"><span class="ruby">-&gt;-- tcp_nopush on;             <span class="comment"># disabled until benchmarked</span></span></div><div class="line"><span class="ruby">-&gt;-- proxy_buffer_size <span class="number">128</span>k;    <span class="comment"># disabled until benchmarked</span></span></div><div class="line"><span class="ruby">-&gt;-- proxy_buffers <span class="number">4</span> <span class="number">256</span>k;      <span class="comment"># disabled until benchmarked</span></span></div><div class="line"><span class="ruby">-&gt;-- proxy_busy_buffers_size <span class="number">256</span>k; <span class="comment"># disabled until benchmarked</span></span></div><div class="line"><span class="ruby">-&gt;-- reset_timedout_connection on; <span class="comment"># disabled until benchmarked</span></span></div><div class="line"><span class="ruby">-&gt; <span class="keyword">end</span></span></div><div class="line"><span class="ruby">-</span></div><div class="line"><span class="ruby">-client_max_body_size $;</span></div><div class="line"><span class="ruby">-proxy_ssl_server_name on;</span></div><div class="line"><span class="ruby">-underscores_in_headers on;</span></div><div class="line"><span class="ruby">-</span></div><div class="line"><span class="ruby"> lua_package_path       <span class="string">'$;;'</span>;</span></div><div class="line"><span class="ruby"> lua_package_cpath      <span class="string">'$;;'</span>;</span></div><div class="line"><span class="ruby"> lua_socket_pool_size   $;</span></div><div class="line"><span class="ruby">+lua_socket_log_errors  off;</span></div><div class="line"><span class="ruby"> lua_max_running_timers <span class="number">4096</span>;</span></div><div class="line"><span class="ruby"> lua_max_pending_timers <span class="number">16384</span>;</span></div><div class="line"><span class="ruby">+lua_ssl_verify_depth   $;</span></div><div class="line"><span class="ruby">+&gt; <span class="keyword">if</span> lua_ssl_trusted_certificate <span class="keyword">then</span></span></div><div class="line"><span class="ruby">+lua_ssl_trusted_certificate <span class="string">'$'</span>;</span></div><div class="line"><span class="ruby">+&gt; <span class="keyword">end</span></span></div><div class="line"><span class="ruby">+</span></div><div class="line"><span class="ruby"> lua_shared_dict kong                        <span class="number">5</span>m;</span></div><div class="line"><span class="ruby">+lua_shared_dict kong_locks                  <span class="number">8</span>m;</span></div><div class="line"><span class="ruby">+lua_shared_dict kong_healthchecks           <span class="number">5</span>m;</span></div><div class="line"><span class="ruby">+lua_shared_dict kong_process_events         <span class="number">5</span>m;</span></div><div class="line"><span class="ruby">+lua_shared_dict kong_cluster_events         <span class="number">5</span>m;</span></div><div class="line"><span class="ruby">+lua_shared_dict kong_rate_limiting_counters <span class="number">12</span>m;</span></div><div class="line"><span class="ruby">+lua_shared_dict kong_core_db_cache          $;</span></div><div class="line"><span class="ruby">+lua_shared_dict kong_core_db_cache_miss     <span class="number">12</span>m;</span></div><div class="line"><span class="ruby"> lua_shared_dict kong_db_cache               $;</span></div><div class="line"><span class="ruby">-&gt; <span class="keyword">if</span> database == <span class="string">"off"</span> <span class="keyword">then</span></span></div><div class="line"><span class="ruby">-lua_shared_dict kong_db_cache_2     $;</span></div><div class="line"><span class="ruby">-&gt; <span class="keyword">end</span></span></div><div class="line"><span class="ruby"> lua_shared_dict kong_db_cache_miss          <span class="number">12</span>m;</span></div><div class="line"><span class="ruby"> &gt; <span class="keyword">if</span> database == <span class="string">"off"</span> <span class="keyword">then</span></span></div><div class="line"><span class="ruby">+lua_shared_dict kong_core_db_cache_2        $;</span></div><div class="line"><span class="ruby">+lua_shared_dict kong_core_db_cache_miss_2   <span class="number">12</span>m;</span></div><div class="line"><span class="ruby">+lua_shared_dict kong_db_cache_2             $;</span></div><div class="line"><span class="ruby"> lua_shared_dict kong_db_cache_miss_2        <span class="number">12</span>m;</span></div><div class="line"><span class="ruby"> &gt; <span class="keyword">end</span></span></div><div class="line"><span class="ruby">-lua_shared_dict kong_locks          <span class="number">8</span>m;</span></div><div class="line"><span class="ruby">-lua_shared_dict kong_process_events <span class="number">5</span>m;</span></div><div class="line"><span class="ruby">-lua_shared_dict kong_cluster_events <span class="number">5</span>m;</span></div><div class="line"><span class="ruby">-lua_shared_dict kong_healthchecks   <span class="number">5</span>m;</span></div><div class="line"><span class="ruby">-lua_shared_dict kong_rate_limiting_counters <span class="number">12</span>m;</span></div><div class="line"><span class="ruby"> &gt; <span class="keyword">if</span> database == <span class="string">"cassandra"</span> <span class="keyword">then</span></span></div><div class="line"><span class="ruby"> lua_shared_dict kong_cassandra              <span class="number">5</span>m;</span></div><div class="line"><span class="ruby"> &gt; <span class="keyword">end</span></span></div><div class="line"><span class="ruby">-lua_socket_log_errors off;</span></div><div class="line"><span class="ruby">-&gt; <span class="keyword">if</span> lua_ssl_trusted_certificate <span class="keyword">then</span></span></div><div class="line"><span class="ruby">-lua_ssl_trusted_certificate <span class="string">'$'</span>;</span></div><div class="line"><span class="ruby">+&gt; <span class="keyword">if</span> role == <span class="string">"control_plane"</span> <span class="keyword">then</span></span></div><div class="line"><span class="ruby">+lua_shared_dict kong_clustering             <span class="number">5</span>m;</span></div><div class="line"><span class="ruby">+&gt; <span class="keyword">end</span></span></div><div class="line"><span class="ruby">+</span></div><div class="line"><span class="ruby">+underscores_in_headers on;</span></div><div class="line"><span class="ruby">+&gt; <span class="keyword">if</span> ssl_ciphers <span class="keyword">then</span></span></div><div class="line"><span class="ruby">+ssl_ciphers $;</span></div><div class="line"><span class="ruby"> &gt; <span class="keyword">end</span></span></div><div class="line"><span class="ruby">-lua_ssl_verify_depth $;</span></div><div class="line"><span class="ruby"></span></div><div class="line"><span class="ruby"> <span class="comment"># injected nginx_http_* directives</span></span></div><div class="line"><span class="ruby"> &gt; <span class="keyword">for</span> <span class="number">_</span>, el <span class="keyword">in</span> ipairs(nginx_http_directives) <span class="keyword">do</span></span></div><div class="line"><span class="ruby">@@ -<span class="number">66</span>,<span class="number">61</span> +<span class="number">60</span>,<span class="number">47</span> @@ init_worker_by_lua_block &#123;</span></div><div class="line"><span class="ruby">     Kong.init_worker()</span></div><div class="line"><span class="ruby"> &#125;</span></div><div class="line"><span class="ruby"></span></div><div class="line"><span class="ruby">-</span></div><div class="line"><span class="ruby">-&gt; <span class="keyword">if</span> <span class="comment">#proxy_listeners &gt; 0 then</span></span></div><div class="line"><span class="ruby">+&gt; <span class="keyword">if</span> (role == <span class="string">"traditional"</span> <span class="keyword">or</span> role == <span class="string">"data_plane"</span>) <span class="keyword">and</span> <span class="comment">#proxy_listeners &gt; 0 then</span></span></div><div class="line"><span class="ruby"> upstream kong_upstream &#123;</span></div><div class="line"><span class="ruby">     server <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">1</span>;</span></div><div class="line"><span class="ruby">     balancer_by_lua_block &#123;</span></div><div class="line"><span class="ruby">         Kong.balancer()</span></div><div class="line"><span class="ruby">     &#125;</span></div><div class="line"><span class="ruby"></span></div><div class="line"><span class="ruby">-<span class="comment"># injected nginx_http_upstream_* directives</span></span></div><div class="line"><span class="ruby">-&gt; <span class="keyword">for</span> <span class="number">_</span>, el <span class="keyword">in</span> ipairs(nginx_http_upstream_directives) <span class="keyword">do</span></span></div><div class="line"><span class="ruby">+    <span class="comment"># injected nginx_upstream_* directives</span></span></div><div class="line"><span class="ruby">+&gt; <span class="keyword">for</span> <span class="number">_</span>, el <span class="keyword">in</span> ipairs(nginx_upstream_directives) <span class="keyword">do</span></span></div><div class="line"><span class="ruby">     $(el.name) $(el.value);</span></div><div class="line"><span class="ruby"> &gt; <span class="keyword">end</span></span></div><div class="line"><span class="ruby"> &#125;</span></div><div class="line"><span class="ruby"></span></div><div class="line"><span class="ruby"> server &#123;</span></div><div class="line"><span class="ruby">     server_name kong;</span></div><div class="line"><span class="ruby">-&gt; <span class="keyword">for</span> i = <span class="number">1</span>, <span class="comment">#proxy_listeners do</span></span></div><div class="line"><span class="ruby">-    listen $(proxy_listeners[i].listener);</span></div><div class="line"><span class="ruby">+&gt; <span class="keyword">for</span> <span class="number">_</span>, entry <span class="keyword">in</span> ipairs(proxy_listeners) <span class="keyword">do</span></span></div><div class="line"><span class="ruby">+    listen $(entry.listener);</span></div><div class="line"><span class="ruby"> &gt; <span class="keyword">end</span></span></div><div class="line"><span class="ruby">+</span></div><div class="line"><span class="ruby">     error_page <span class="number">400</span> <span class="number">404</span> <span class="number">408</span> <span class="number">411</span> <span class="number">412</span> <span class="number">413</span> <span class="number">414</span> <span class="number">417</span> <span class="number">494</span> /kong_error_handler;</span></div><div class="line"><span class="ruby">     error_page <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>                     /kong_error_handler;</span></div><div class="line"><span class="ruby"></span></div><div class="line"><span class="ruby">     access_log $;</span></div><div class="line"><span class="ruby">     error_log  $ $;</span></div><div class="line"><span class="ruby"></span></div><div class="line"><span class="ruby">-    client_body_buffer_size $;</span></div><div class="line"><span class="ruby">-</span></div><div class="line"><span class="ruby"> &gt; <span class="keyword">if</span> proxy_ssl_enabled <span class="keyword">then</span></span></div><div class="line"><span class="ruby">     ssl_certificate     $;</span></div><div class="line"><span class="ruby">     ssl_certificate_key $;</span></div><div class="line"><span class="ruby">+    ssl_session_cache   <span class="symbol">shared:</span><span class="symbol">SSL:</span><span class="number">10</span>m;</span></div><div class="line"><span class="ruby">     ssl_certificate_by_lua_block &#123;</span></div><div class="line"><span class="ruby">         Kong.ssl_certificate()</span></div><div class="line"><span class="ruby">     &#125;</span></div><div class="line"><span class="ruby">-</span></div><div class="line"><span class="ruby">-    ssl_session_cache <span class="symbol">shared:</span><span class="symbol">SSL:</span><span class="number">10</span>m;</span></div><div class="line"><span class="ruby">-    ssl_session_timeout <span class="number">10</span>m;</span></div><div class="line"><span class="ruby">-    ssl_prefer_server_ciphers on;</span></div><div class="line"><span class="ruby">-    ssl_ciphers $;</span></div><div class="line"><span class="ruby">-&gt; <span class="keyword">end</span></span></div><div class="line"><span class="ruby">-</span></div><div class="line"><span class="ruby">-&gt; <span class="keyword">if</span> client_ssl <span class="keyword">then</span></span></div><div class="line"><span class="ruby">-    proxy_ssl_certificate $;</span></div><div class="line"><span class="ruby">-    proxy_ssl_certificate_key $;</span></div><div class="line"><span class="ruby">-&gt; <span class="keyword">end</span></span></div><div class="line"><span class="ruby">-</span></div><div class="line"><span class="ruby">-    real_ip_header     $;</span></div><div class="line"><span class="ruby">-    real_ip_recursive  $;</span></div><div class="line"><span class="ruby">-&gt; <span class="keyword">for</span> i = <span class="number">1</span>, <span class="comment">#trusted_ips do</span></span></div><div class="line"><span class="ruby">-    set_real_ip_from   $(trusted_ips[i]);</span></div><div class="line"><span class="ruby"> &gt; <span class="keyword">end</span></span></div><div class="line"><span class="ruby"></span></div><div class="line"><span class="ruby">     <span class="comment"># injected nginx_proxy_* directives</span></span></div><div class="line"><span class="ruby"> &gt; <span class="keyword">for</span> <span class="number">_</span>, el <span class="keyword">in</span> ipairs(nginx_proxy_directives) <span class="keyword">do</span></span></div><div class="line"><span class="ruby">     $(el.name) $(el.value);</span></div><div class="line"><span class="ruby"> &gt; <span class="keyword">end</span></span></div><div class="line"><span class="ruby">+&gt; <span class="keyword">for</span> i = <span class="number">1</span>, <span class="comment">#trusted_ips do</span></span></div><div class="line"><span class="ruby">+    set_real_ip_from  $(trusted_ips[i]);</span></div><div class="line"><span class="ruby">+&gt; <span class="keyword">end</span></span></div><div class="line"><span class="ruby"></span></div><div class="line"><span class="ruby">     rewrite_by_lua_block &#123;</span></div><div class="line"><span class="ruby">         Kong.rewrite()</span></div><div class="line"><span class="ruby">@@ -<span class="number">171</span>,<span class="number">43</span> +<span class="number">151</span>,<span class="number">93</span> @@ server &#123;</span></div><div class="line"><span class="ruby">         proxy_pass_header     Server;</span></div><div class="line"><span class="ruby">         proxy_pass_header     Date;</span></div><div class="line"><span class="ruby">         proxy_ssl_name        $upstream_host;</span></div><div class="line"><span class="ruby">+        proxy_ssl_server_name on;</span></div><div class="line"><span class="ruby">+&gt; <span class="keyword">if</span> client_ssl <span class="keyword">then</span></span></div><div class="line"><span class="ruby">+        proxy_ssl_certificate $;</span></div><div class="line"><span class="ruby">+        proxy_ssl_certificate_key $;</span></div><div class="line"><span class="ruby">+&gt; <span class="keyword">end</span></span></div><div class="line"><span class="ruby">         proxy_pass            $upstream_scheme<span class="symbol">://kong_upstream</span>$upstream_uri;</span></div><div class="line"><span class="ruby">     &#125;</span></div><div class="line"><span class="ruby"></span></div><div class="line"><span class="ruby">     location @grpc &#123;</span></div><div class="line"><span class="ruby">         internal;</span></div><div class="line"><span class="ruby">+        default_type         <span class="string">''</span>;</span></div><div class="line"><span class="ruby">         set $kong_proxy_mode <span class="string">'grpc'</span>;</span></div><div class="line"><span class="ruby"></span></div><div class="line"><span class="ruby">+        grpc_set_header      TE                $upstream_te;</span></div><div class="line"><span class="ruby">         grpc_set_header      Host              $upstream_host;</span></div><div class="line"><span class="ruby">         grpc_set_header      X-Forwarded-For   $upstream_x_forwarded_for;</span></div><div class="line"><span class="ruby">         grpc_set_header      X-Forwarded-Proto $upstream_x_forwarded_proto;</span></div><div class="line"><span class="ruby">         grpc_set_header      X-Forwarded-Host  $upstream_x_forwarded_host;</span></div><div class="line"><span class="ruby">         grpc_set_header      X-Forwarded-Port  $upstream_x_forwarded_port;</span></div><div class="line"><span class="ruby">         grpc_set_header      X-Real-IP         $remote_addr;</span></div><div class="line"><span class="ruby">-</span></div><div class="line"><span class="ruby">+        grpc_pass_header     Server;</span></div><div class="line"><span class="ruby">+        grpc_pass_header     Date;</span></div><div class="line"><span class="ruby">         grpc_pass            <span class="symbol">grpc:</span>/<span class="regexp">/kong_upstream;</span></span></div><div class="line"><span class="ruby">     &#125;</span></div><div class="line"><span class="ruby"></span></div><div class="line"><span class="ruby">     location @grpcs &#123;</span></div><div class="line"><span class="ruby">         internal;</span></div><div class="line"><span class="ruby">+        default_type         <span class="string">''</span>;</span></div><div class="line"><span class="ruby">         set $kong_proxy_mode <span class="string">'grpc'</span>;</span></div><div class="line"><span class="ruby"></span></div><div class="line"><span class="ruby">+        grpc_set_header      TE                $upstream_te;</span></div><div class="line"><span class="ruby">         grpc_set_header      Host              $upstream_host;</span></div><div class="line"><span class="ruby">         grpc_set_header      X-Forwarded-For   $upstream_x_forwarded_for;</span></div><div class="line"><span class="ruby">         grpc_set_header      X-Forwarded-Proto $upstream_x_forwarded_proto;</span></div><div class="line"><span class="ruby">         grpc_set_header      X-Forwarded-Host  $upstream_x_forwarded_host;</span></div><div class="line"><span class="ruby">         grpc_set_header      X-Forwarded-Port  $upstream_x_forwarded_port;</span></div><div class="line"><span class="ruby">         grpc_set_header      X-Real-IP         $remote_addr;</span></div><div class="line"><span class="ruby">-</span></div><div class="line"><span class="ruby">+        grpc_pass_header     Server;</span></div><div class="line"><span class="ruby">+        grpc_pass_header     Date;</span></div><div class="line"><span class="ruby">+        grpc_ssl_name        $upstream_host;</span></div><div class="line"><span class="ruby">+        grpc_ssl_server_name on;</span></div><div class="line"><span class="ruby">+&gt; <span class="keyword">if</span> client_ssl <span class="keyword">then</span></span></div><div class="line"><span class="ruby">+        grpc_ssl_certificate $;</span></div><div class="line"><span class="ruby">+        grpc_ssl_certificate_key $;</span></div><div class="line"><span class="ruby">+&gt; <span class="keyword">end</span></span></div><div class="line"><span class="ruby">         grpc_pass            <span class="symbol">grpcs:</span>/<span class="regexp">/kong_upstream;</span></span></div><div class="line"><span class="ruby">     &#125;</span></div><div class="line"><span class="ruby"></span></div><div class="line"><span class="ruby">+    location = <span class="regexp">/kong_buffered_http &#123;</span></span></div><div class="line"><span class="ruby">+        internal;</span></div><div class="line"><span class="ruby">+        default_type         <span class="string">''</span>;</span></div><div class="line"><span class="ruby">+        set $kong_proxy_mode <span class="string">'http'</span>;</span></div><div class="line"><span class="ruby">+</span></div><div class="line"><span class="ruby">+        rewrite_by_lua_block       &#123;;&#125;</span></div><div class="line"><span class="ruby">+        access_by_lua_block        &#123;;&#125;</span></div><div class="line"><span class="ruby">+        header_filter_by_lua_block &#123;;&#125;</span></div><div class="line"><span class="ruby">+        body_filter_by_lua_block   &#123;;&#125;</span></div><div class="line"><span class="ruby">+        log_by_lua_block           &#123;;&#125;</span></div><div class="line"><span class="ruby">+</span></div><div class="line"><span class="ruby">+        proxy_http_version <span class="number">1.1</span>;</span></div><div class="line"><span class="ruby">+        proxy_set_header      TE                $upstream_te;</span></div><div class="line"><span class="ruby">+        proxy_set_header      Host              $upstream_host;</span></div><div class="line"><span class="ruby">+        proxy_set_header      Upgrade           $upstream_upgrade;</span></div><div class="line"><span class="ruby">+        proxy_set_header      Connection        $upstream_connection;</span></div><div class="line"><span class="ruby">+        proxy_set_header      X-Forwarded-For   $upstream_x_forwarded_for;</span></div><div class="line"><span class="ruby">+        proxy_set_header      X-Forwarded-Proto $upstream_x_forwarded_proto;</span></div><div class="line"><span class="ruby">+        proxy_set_header      X-Forwarded-Host  $upstream_x_forwarded_host;</span></div><div class="line"><span class="ruby">+        proxy_set_header      X-Forwarded-Port  $upstream_x_forwarded_port;</span></div><div class="line"><span class="ruby">+        proxy_set_header      X-Real-IP         $remote_addr;</span></div><div class="line"><span class="ruby">+        proxy_pass_header     Server;</span></div><div class="line"><span class="ruby">+        proxy_pass_header     Date;</span></div><div class="line"><span class="ruby">+        proxy_ssl_name        $upstream_host;</span></div><div class="line"><span class="ruby">+        proxy_ssl_server_name on;</span></div><div class="line"><span class="ruby">+&gt; <span class="keyword">if</span> client_ssl <span class="keyword">then</span></span></div><div class="line"><span class="ruby">+        proxy_ssl_certificate $;</span></div><div class="line"><span class="ruby">+        proxy_ssl_certificate_key $;</span></div><div class="line"><span class="ruby">+&gt; <span class="keyword">end</span></span></div><div class="line"><span class="ruby">+        proxy_pass            $upstream_scheme<span class="symbol">://kong_upstream</span>$upstream_uri;</span></div><div class="line"><span class="ruby">+    &#125;</span></div><div class="line"><span class="ruby">+</span></div><div class="line"><span class="ruby">     location = <span class="regexp">/kong_error_handler &#123;</span></span></div><div class="line"><span class="ruby">         internal;</span></div><div class="line"><span class="ruby">+        default_type                 <span class="string">''</span>;</span></div><div class="line"><span class="ruby">+</span></div><div class="line"><span class="ruby">         uninitialized_variable_warn  off;</span></div><div class="line"><span class="ruby"></span></div><div class="line"><span class="ruby">         rewrite_by_lua_block &#123;;&#125;</span></div><div class="line"><span class="ruby">-</span></div><div class="line"><span class="ruby">         access_by_lua_block  &#123;;&#125;</span></div><div class="line"><span class="ruby"></span></div><div class="line"><span class="ruby">         content_by_lua_block &#123;</span></div><div class="line"><span class="ruby">@@ -<span class="number">215</span>,<span class="number">13</span> +<span class="number">245</span>,<span class="number">13</span> @@ server &#123;</span></div><div class="line"><span class="ruby">         &#125;</span></div><div class="line"><span class="ruby">     &#125;</span></div><div class="line"><span class="ruby"> &#125;</span></div><div class="line"><span class="ruby">-&gt; <span class="keyword">end</span></span></div><div class="line"><span class="ruby">+&gt; <span class="keyword">end</span> -- (role == <span class="string">"traditional"</span> <span class="keyword">or</span> role == <span class="string">"data_plane"</span>) <span class="keyword">and</span> <span class="comment">#proxy_listeners &gt; 0</span></span></div><div class="line"><span class="ruby"></span></div><div class="line"><span class="ruby">-&gt; <span class="keyword">if</span> <span class="comment">#admin_listeners &gt; 0 then</span></span></div><div class="line"><span class="ruby">+&gt; <span class="keyword">if</span> (role == <span class="string">"control_plane"</span> <span class="keyword">or</span> role == <span class="string">"traditional"</span>) <span class="keyword">and</span> <span class="comment">#admin_listeners &gt; 0 then</span></span></div><div class="line"><span class="ruby"> server &#123;</span></div><div class="line"><span class="ruby">     server_name kong_admin;</span></div><div class="line"><span class="ruby">-&gt; <span class="keyword">for</span> i = <span class="number">1</span>, <span class="comment">#admin_listeners do</span></span></div><div class="line"><span class="ruby">-    listen $(admin_listeners[i].listener);</span></div><div class="line"><span class="ruby">+&gt; <span class="keyword">for</span> <span class="number">_</span>, entry <span class="keyword">in</span> ipairs(admin_listeners) <span class="keyword">do</span></span></div><div class="line"><span class="ruby">+    listen $(entry.listener);</span></div><div class="line"><span class="ruby"> &gt; <span class="keyword">end</span></span></div><div class="line"><span class="ruby"></span></div><div class="line"><span class="ruby">     access_log $;</span></div><div class="line"><span class="ruby">@@ -<span class="number">233</span>,<span class="number">11</span> +<span class="number">263</span>,<span class="number">7</span> @@ server &#123;</span></div><div class="line"><span class="ruby"> &gt; <span class="keyword">if</span> admin_ssl_enabled <span class="keyword">then</span></span></div><div class="line"><span class="ruby">     ssl_certificate     $;</span></div><div class="line"><span class="ruby">     ssl_certificate_key $;</span></div><div class="line"><span class="ruby">-</span></div><div class="line"><span class="ruby">-    ssl_session_cache <span class="symbol">shared:</span><span class="symbol">SSL:</span><span class="number">10</span>m;</span></div><div class="line"><span class="ruby">-    ssl_session_timeout <span class="number">10</span>m;</span></div><div class="line"><span class="ruby">-    ssl_prefer_server_ciphers on;</span></div><div class="line"><span class="ruby">-    ssl_ciphers $;</span></div><div class="line"><span class="ruby">+    ssl_session_cache   <span class="symbol">shared:</span><span class="symbol">AdminSSL:</span><span class="number">10</span>m;</span></div><div class="line"><span class="ruby"> &gt; <span class="keyword">end</span></span></div><div class="line"><span class="ruby"></span></div><div class="line"><span class="ruby">     <span class="comment"># injected nginx_admin_* directives</span></span></div><div class="line"><span class="ruby">@@ -<span class="number">265</span>,<span class="number">20</span> +<span class="number">291</span>,<span class="number">20</span> @@ server &#123;</span></div><div class="line"><span class="ruby">         <span class="keyword">return</span> <span class="number">200</span> <span class="string">'User-agent: *\nDisallow: /'</span>;</span></div><div class="line"><span class="ruby">     &#125;</span></div><div class="line"><span class="ruby"> &#125;</span></div><div class="line"><span class="ruby">-&gt; <span class="keyword">end</span></span></div><div class="line"><span class="ruby">+&gt; <span class="keyword">end</span> -- (role == <span class="string">"control_plane"</span> <span class="keyword">or</span> role == <span class="string">"traditional"</span>) <span class="keyword">and</span> <span class="comment">#admin_listeners &gt; 0</span></span></div><div class="line"><span class="ruby"></span></div><div class="line"><span class="ruby"> &gt; <span class="keyword">if</span> <span class="comment">#status_listeners &gt; 0 then</span></span></div><div class="line"><span class="ruby"> server &#123;</span></div><div class="line"><span class="ruby">     server_name kong_status;</span></div><div class="line"><span class="ruby">-&gt; <span class="keyword">for</span> i = <span class="number">1</span>, <span class="comment">#status_listeners do</span></span></div><div class="line"><span class="ruby">-    listen $(status_listeners[i].listener);</span></div><div class="line"><span class="ruby">+&gt; <span class="keyword">for</span> <span class="number">_</span>, entry <span class="keyword">in</span> ipairs(status_listeners) <span class="keyword">do</span></span></div><div class="line"><span class="ruby">+    listen $(entry.listener);</span></div><div class="line"><span class="ruby"> &gt; <span class="keyword">end</span></span></div><div class="line"><span class="ruby"></span></div><div class="line"><span class="ruby">     access_log $;</span></div><div class="line"><span class="ruby">     error_log  $ $;</span></div><div class="line"><span class="ruby"></span></div><div class="line"><span class="ruby">-    <span class="comment"># injected nginx_http_status_* directives</span></span></div><div class="line"><span class="ruby">-&gt; <span class="keyword">for</span> <span class="number">_</span>, el <span class="keyword">in</span> ipairs(nginx_http_status_directives) <span class="keyword">do</span></span></div><div class="line"><span class="ruby">+    <span class="comment"># injected nginx_status_* directives</span></span></div><div class="line"><span class="ruby">+&gt; <span class="keyword">for</span> <span class="number">_</span>, el <span class="keyword">in</span> ipairs(nginx_status_directives) <span class="keyword">do</span></span></div><div class="line"><span class="ruby">     $(el.name) $(el.value);</span></div><div class="line"><span class="ruby"> &gt; <span class="keyword">end</span></span></div><div class="line"><span class="ruby"></span></div><div class="line"><span class="ruby">@@ -<span class="number">303</span>,<span class="number">4</span> +<span class="number">329</span>,<span class="number">26</span> @@ server &#123;</span></div><div class="line"><span class="ruby">     &#125;</span></div><div class="line"><span class="ruby"> &#125;</span></div><div class="line"><span class="ruby"> &gt; <span class="keyword">end</span></span></div><div class="line"><span class="ruby">+</span></div><div class="line"><span class="ruby">+&gt; <span class="keyword">if</span> role == <span class="string">"control_plane"</span> <span class="keyword">then</span></span></div><div class="line"><span class="ruby">+server &#123;</span></div><div class="line"><span class="ruby">+    server_name kong_cluster_listener;</span></div><div class="line"><span class="ruby">+&gt; <span class="keyword">for</span> <span class="number">_</span>, entry <span class="keyword">in</span> ipairs(cluster_listeners) <span class="keyword">do</span></span></div><div class="line"><span class="ruby">+    listen $(entry.listener) ssl;</span></div><div class="line"><span class="ruby">+&gt; <span class="keyword">end</span></span></div><div class="line"><span class="ruby">+</span></div><div class="line"><span class="ruby">+    access_log off;</span></div><div class="line"><span class="ruby">+</span></div><div class="line"><span class="ruby">+    ssl_verify_client   optional_no_ca;</span></div><div class="line"><span class="ruby">+    ssl_certificate     $;</span></div><div class="line"><span class="ruby">+    ssl_certificate_key $;</span></div><div class="line"><span class="ruby">+    ssl_session_cache   <span class="symbol">shared:</span><span class="symbol">ClusterSSL:</span><span class="number">10</span>m;</span></div><div class="line"><span class="ruby">+</span></div><div class="line"><span class="ruby">+    location = <span class="regexp">/v1/outlet</span> &#123;</span></div><div class="line"><span class="ruby">+        content_by_lua_block &#123;</span></div><div class="line"><span class="ruby">+            Kong.serve_cluster_listener()</span></div><div class="line"><span class="ruby">+        &#125;</span></div><div class="line"><span class="ruby">+    &#125;</span></div><div class="line"><span class="ruby">+&#125;</span></div><div class="line"><span class="ruby">+&gt; <span class="keyword">end</span> -- role == <span class="string">"control_plane"</span></span></div><div class="line"><span class="ruby"> ]]</span></div></pre></td></tr></table></figure>
<h2 id="3-建议升级路径"><a href="#3-建议升级路径" class="headerlink" title="3. 建议升级路径"></a>3. 建议升级路径</h2><h3 id="从0-x升级到2-0-0"><a href="#从0-x升级到2-0-0" class="headerlink" title="从0.x升级到2.0.0"></a>从<code>0.x</code>升级到<code>2.0.0</code></h3><p>Kong 2.0.0支持迁移的最低版本是1.0.0。如果您是从低于0.14.1的版本迁移，那么首先需要迁移到0.14.1。然后，如果是从0.14.1开始迁移，请先升级到到1.5.0。</p>
<p>从0.14.1升级到1.5.0的步骤与从0.14.1升级到Kong 1.0的步骤相同。请遵循Kong 1.0建议升级路径中的“从0.14迁移步骤”中描述的步骤，并添加<code>kong migrations migrate-apis</code>命令，您可以使用该命令迁移保留<code>apis</code>配置。</p>
<p>当迁移到1.5.0之后，可以按照下面一节中的说明迁移到2.0.0。</p>
<h3 id="从1-0-0-1-5-0-升级到-2-0-0"><a href="#从1-0-0-1-5-0-升级到-2-0-0" class="headerlink" title="从1.0.0 - 1.5.0 升级到 2.0.0"></a>从<code>1.0.0</code> - <code>1.5.0</code> 升级到 <code>2.0.0</code></h3><p>Kong 2.0.0支持无停机迁移模型。这意味着在迁移过程中，您将运行两个Kong集群，共享相同的数据库。(这有时被称为蓝/绿迁移模型。)</p>
<p>迁移的设计使得不需要完全复制数据。但这也意味着它们的设计方式使得新版Kong能够在迁移过程中使用数据，并且要以一种方式来完成它，使旧的Kong集群能够一直工作，直到它最终下线。由于这个原因，整个迁移现在分成两个步骤，通过命令<code>kong migrations up</code>(只执行非破性操作)和<code>kong migrations finish</code>(将数据库置于kong 2.0.0的最终预期状态)执行。</p>
<ol>
<li>下载2.0.0，并将其配置为指向与旧集群(1.0到1.5)相同的数据存储。运行<code>kong migration up</code>。</li>
<li>一旦它完成运行，旧集群和新集群(2.0.0)现在可以在同一个数据存储上同时运行。开始供应2.0.0节点，但还不使用它们的管理API。如果需要执行管理API请求，应该对旧集群的节点执行这些请求。其原因是为了防止新集群生成旧集群无法识别的数据。</li>
<li>逐渐将流量从旧节点转移到2.0.0集群中。监控你的流程以确保一切顺利。</li>
<li>当您的流量完全迁移到2.0.0集群时，下线您的旧节点。</li>
<li>在2.0.0集群中运行:<code>kong migration finish</code>。从现在起，将不能在旧集群中启动指向相同数据存储的节点。只有在确信迁移成功时才运行此命令。从现在开始，您可以安全地向2.0.0节点发出管理API请求。</li>
</ol>
<h3 id="在新的数据存储上安装2-0-0"><a href="#在新的数据存储上安装2-0-0" class="headerlink" title="在新的数据存储上安装2.0.0"></a>在新的数据存储上安装2.0.0</h3><p>下面的命令应该用于从新的数据存储准备新的2.0.0集群:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> kong migrations bootstrap [-c config]</span></div><div class="line"><span class="meta">$</span><span class="bash"> kong start [-c config]</span></div></pre></td></tr></table></figure>
</div><div class="post-copyright"><script type="text/javascript" src="/js/copyright.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copyright.css"><p><span>本文标题：</span>微服务 API 网关 Kong 2.0.0 升级指南</p><p><span>文章作者：</span>qianyugang</p><p><span>发布时间：</span>2020-06-05</p><p><span>最后更新：</span>2020-06-05</p><p><span>原始链接：</span><a href="/2020/06/05/kong-2.0-upgrade-guide/">https://102no.com/2020/06/05/kong-2.0-upgrade-guide/</a><span class="copy-path"><i class="fa fa-clipboard" data-clipboard-text="https://102no.com/2020/06/05/kong-2.0-upgrade-guide/"></i></span></p><p><span>版权声明：</span>本网站发表的全部原创内容（不仅限于文章、图片，包含文章评论），著作权均归其发表者所有，均采用 <a href="https://creativecommons.org/licenses/by-nc/4.0/deed.zh" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0 CN</a> 许可协议。转载请注明作者以及原文链接，商业授权请联系作者。<br> <br> <p style="text-align:center"> <img src="https://i.loli.net/2020/11/16/7kT8gNZjuI3Kmex.png" width="90%"><br><br></p></p></div><br><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a class="article-share-link" data-url="https://102no.com/2020/06/05/kong-2.0-upgrade-guide/" data-id="clwoq9q8m00b5bl9dq042rvta" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACLUlEQVR42u3aUY6DMAxF0e5/08wCRoT7bDqjODdfCEHDSSUrtvP54HHdjPWTv++vr+/uvDZkyJCxLeNajvXH8YnXS0DmfVhEGTJkHMBYf1waLtcwHqyDhZMhQ4aM5fV6+gsMMq8MGTJk1BgcSZLhfwu4MmTI2IRBJqgVy9Lf+XouLkOGjA0ZvOr+99df6W/IkCFjK8YVjrTExktvnSFDhozZjE4DstMA6AdcGTJknMOolfX71PRIx8MdGTJkjGb0S1rpR6QfylsOMmTIOI1BQi1np0/yBPiTRnEZMmRsyKgd1UpDZH+j+ZD6ypAh4xgGKYTVwmineUnaEjJkyDiNwQthnMfnSpugtwFXhgwZgxik3cgT1M52kKe1D18lQ4aMcYy32pO8TMY3iMGyypAhYzSj1h6otQpqSWxw2EKGDBmjGfwwBN8CkuNlacB9uCNDhowjGWmBjEf3WvOyGHBlyJAxgkF+mm/X+JbxG0sgQ4aM2Yw0+Nbalv2FiP8TGTJkjGCk6SIpuqXv1pqgt0msDBkyhjL6iesL8R7X+VE/VoYMGeMYaXMxPfhVa14GiyJDhoyhjCscvHz/VphGb8mQIWM0I20DkI/mQbYflGOMDBkytmV0Woy8KJZuGclbKMbLkCFjECMNfP3mQb8MJ0OGDBlkmlpo5gE62NXKkCFDRntjlx4RSzevMmTIOIHBj1x0ymRpYS74HRkyZIxm1FJH3rysPfPWEQ0ZMmRszvgBqMr6CDcpJLAAAAAASUVORK5CYII=">分享</a><div class="tags"><a href="/tags/Kong/"><i class="fa fa-tag"></i>Kong</a><a href="/tags/Kong中文文档/"><i class="fa fa-tag"></i>Kong中文文档</a><a href="/tags/Kong升级指南/"><i class="fa fa-tag"></i>Kong升级指南</a></div><div class="post-nav"><a class="pre" href="/2020/06/30/how-to-quickly-locate-a-company/">如何快速定位一家公司是否靠谱</a><a class="next" href="/2020/05/21/wordpress-migration-to-hexo/">终于抛弃了使用8年的WordPress</a></div><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'true' == 'true' ? true : false;
var verify = 'false' == 'true' ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'JyXcMD3pqe0hk6LmrzbiF7Ia-gzGzoHsz',
  appKey:'gPRoQRTwyYE8eA74yorDb6cf',
  placeholder:'Just so so',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'20'
})
</script></div></div></div><div class="pure-u-1 pure-u-md-1-4"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://102no.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/与代码/">与代码</a><span class="category-list-count">123</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/乱七八糟/">乱七八糟</a><span class="category-list-count">20</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/我是修电脑的/">我是修电脑的</a><span class="category-list-count">26</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/说过的话/">说过的话</a><span class="category-list-count">45</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/走过的路/">走过的路</a><span class="category-list-count">22</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2024/05/27/dou-jiao-zheng-mian/">豆角蒸面</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/03/02/kong-3.6/">Kong Gateway 3.6.x 正式发布，较大改变！</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/02/07/xiang-yang-niu-rou-mian/">襄阳牛肉面🍜</a></li><li class="post-list-item"><a class="post-list-link" href="/2024/01/09/32th-dongzhi/">第三十二年冬至</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/10/09/kong-manager-oss/">Kong Gateway OSS 官方管理界面 Kong Manager 开源啦！🦍</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/09/26/zhihu-zhongqiu/">知乎2023中秋月饼礼盒开箱！🥮</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/06/07/apple-vision-pro/">苹果WWDC2023 发布的Apple Vision Pro🍎</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/06/05/high-performance-mysql-4/">《高性能MySQL》第四版：视角升级，拥抱新版📖</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/04/20/kill-roach/">灭蟑螂🪳</a></li><li class="post-list-item"><a class="post-list-link" href="/2023/02/06/chatgtp-alternatives/">ChatGPT 类似产品🤖</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.102no.com/" title="102no.com" target="_blank">102no.com</a><ul></ul><a href="http://blog.forecho.com/" title="forecho's blog" target="_blank">forecho's blog</a><ul></ul><a href="https://blog.forecho.com/friendship-links/" title="博客联盟" target="_blank">博客联盟</a><ul></ul><a href="https://zhou.ge/" title="忆往事" target="_blank">忆往事</a><ul></ul><a href="https://chorder.net/" title="Chorder" target="_blank">Chorder</a><ul></ul><a href="https://atjason.com/" title="Jason" target="_blank">Jason</a><ul></ul><a href="http://jintang.zone/" title="Jintang'Zone" target="_blank">Jintang'Zone</a><ul></ul><a href="https://sergiojune.com/" title="梦开始的地方" target="_blank">梦开始的地方</a><ul></ul><a href="https://www.happysir.com/" title="happysir" target="_blank">happysir</a><ul></ul><a href="https://vulgur.github.io/" title="fork my life" target="_blank">fork my life</a><ul></ul><a href="https://chensenlin.cn/" title="特立独行的异类" target="_blank">特立独行的异类</a><ul></ul><a href="https://wmdpd.com/" title="完美的胖达" target="_blank">完美的胖达</a><ul></ul><a href="https://xbc.me/" title="神秘极客" target="_blank">神秘极客</a><ul></ul><a href="https://hiwannz.com/" title="见字如面" target="_blank">见字如面</a><ul></ul><a href="https://www.sweeterthandespair.com/" title="阿尔法凡" target="_blank">阿尔法凡</a><ul></ul><a href="https://yaoyedan.net/" title="妖业蛋" target="_blank">妖业蛋</a><ul></ul><a href="https://www.geekxh.com/" title="小浩算法" target="_blank">小浩算法</a><ul></ul><a href="https://logi.im/" title="LOGI" target="_blank">LOGI</a><ul></ul><a href="https://www.laruence.com/" title="风雪之隅" target="_blank">风雪之隅</a><ul></ul><a href="https://www.zhangxinxu.com/wordpress/" title="张鑫旭" target="_blank">张鑫旭</a><ul></ul><a href="https://www.ctq6.cn/" title="mikelPan" target="_blank">mikelPan</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2024 <a href="/." rel="nofollow">把酒诗代码，趁乱写年华。.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>